<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Idiom Learning Experiment</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      background: #121212;
      color: #e0e0e0;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      min-height: 100vh;
    }
    .container {
      background: #1e1e1e;
      padding: 40px;
      border-radius: 15px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.7);
      width: 100%;
      max-width: 800px;
      text-align: center;
    }
    h1, h2 {
      color: #bb86fc;
      margin-bottom: 20px;
    }
    input, button {
      font-size: 16px;
      padding: 12px 24px;
      margin: 20px 0;
      border: none;
      border-radius: 8px;
      background: #333;
      color: #e0e0e0;
      transition: background 0.3s;
    }
    input:hover, button:hover { background: #444; }
    input:focus { outline: 2px solid #bb86fc; }
    button:disabled { background: #555; cursor: not-allowed; }
    .question {
      font-size: 24px;
      margin-top: 20px;
      transition: opacity 0.5s ease;
    }
    .fade-out {
      opacity: 0;
    }
    .options {
      display: none;
      justify-content: center;
      gap: 20px;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    .option-btn {
      background: #292929;
      padding: 12px 24px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.5);
      transition: transform 0.2s;
    }
    .option-btn:hover { transform: scale(1.05); }
    canvas {
      margin-top: 40px;
      background: #1e1e1e;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Welcome!</h1>
    <div id="entry">
      <p>Please enter your name to start the experiment:</p>
      <input type="text" id="userName" placeholder="Your Name" />
      <br />
      <button id="startBtn" disabled>Start Experiment</button>
    </div>

    <div id="initialTest" style="display:none;">
      <h2>Initial Test</h2>
      <div class="question" id="initQuestion"></div>
      <div class="options" id="initOptions"></div>
    </div>

    <div id="training2" style="display:none;">
      <h2>Training Phase</h2>
      <h3 id="train2Text"></h3>
      <p id="train2Def"></p>
      <img id="idiomImg" src="" alt="Idiom Illustration" style="max-width:100%; margin-top:20px; border-radius:8px;" />
      <br />
      <button id="playAudio">ðŸ”Š Listen</button>
      <button id="train2Next">Next</button>
    </div>

    <div id="postTest" style="display:none;">
      <h2>Post Test</h2>
      <div class="question" id="postQuestion"></div>
      <div class="options" id="postOptions"></div>
    </div>

    <div id="result" style="display:none;">
      <h2>Results for <span id="displayName"></span></h2>
      <p id="scoreChange"></p>
      <p id="timeChange"></p>
      <canvas id="chart" width="400" height="200"></canvas>
    </div>
  </div>

  <script>
    const idioms = [
      { text: "To get off the hook", meaningEn: "To escape from an unpleasant situation" },
      { text: "To fly off the handle", meaningEn: "To lose your temper suddenly" },
      { text: "To lay something at somebodyâ€™s door", meaningEn: "To blame someone for something" },
      { text: "To paint the town red", meaningEn: "To go out and party exuberantly" },
      { text: "To get cold feet", meaningEn: "To suddenly become nervous or afraid to do something" },
      { text: "To hang fire", meaningEn: "To delay making a decision" },
      { text: "To stick to your guns", meaningEn: "To maintain your position firmly" },
      { text: "To have had your fill of something", meaningEn: "To be fed up or tired of something" },
      { text: "To sit on the fence", meaningEn: "To avoid taking sides in a dispute" },
      { text: "To be in for it", meaningEn: "To be about to experience something unpleasant" },
      { text: "To play the field", meaningEn: "To date multiple people without committing" },
      { text: "To show your hand", meaningEn: "To reveal your intentions or plans" },
      { text: "To wear your heart on your sleeve", meaningEn: "To openly show your emotions" },
      { text: "To carry the day", meaningEn: "To win or succeed in a conflict or competition" },
      { text: "To manage to keep a straight face", meaningEn: "To not laugh or show emotion" }
    ];

    let userName = '', initIdx = 0, postIdx = 0;
    let trainRound = 0, trainIdx = 0;
    let startTime, responsesInit = [], responsesPost = [];

    const els = {
      entry: document.getElementById('entry'),
      userNameInput: document.getElementById('userName'),
      startBtn: document.getElementById('startBtn'),
      displayName: document.getElementById('displayName'),
      initDiv: document.getElementById('initialTest'), initQ: document.getElementById('initQuestion'), initO: document.getElementById('initOptions'),
      t2: document.getElementById('training2'), t2Text: document.getElementById('train2Text'), t2Def: document.getElementById('train2Def'), idiomImg: document.getElementById('idiomImg'), t2Audio: document.getElementById('playAudio'), t2Next: document.getElementById('train2Next'),
      postDiv: document.getElementById('postTest'), postQ: document.getElementById('postQuestion'), postO: document.getElementById('postOptions'),
      result: document.getElementById('result'), score: document.getElementById('scoreChange'), time: document.getElementById('timeChange'), chart: document.getElementById('chart')
    };

    els.userNameInput.addEventListener('input', () => {
      els.startBtn.disabled = els.userNameInput.value.trim() === '';
    });

    els.startBtn.addEventListener('click', () => {
      userName = els.userNameInput.value.trim();
      els.displayName.textContent = userName;
      els.entry.style.display = 'none';
      startInitial();
    });

    function getRandomWrong(correctIdx) {
      const pool = idioms.filter((_, i) => i !== correctIdx);
      return pool[Math.floor(Math.random() * pool.length)];
    }

    function startInitial() {
      els.initDiv.style.display = 'block';
      initIdx = 0;
      nextInit();
    }

    function nextInit() {
      if (initIdx >= idioms.length) {
        els.initDiv.style.display = 'none';
        startTraining();
        return;
      }

      const cur = idioms[initIdx];
      els.initQ.classList.remove('fade-out');
      els.initQ.style.display = 'block';
      els.initO.style.display = 'none';
      els.initQ.textContent = `${initIdx + 1}. ${cur.text}`;
      els.initO.innerHTML = '';

      const wrong = getRandomWrong(initIdx);
      const opts = [cur.meaningEn, wrong.meaningEn].sort();
      opts.forEach(opt => {
        const btn = document.createElement('button');
        btn.className = 'option-btn';
        btn.textContent = opt;
        btn.onclick = () => {
          responsesInit.push({ correct: opt === cur.meaningEn, time: Date.now() - startTime });
          initIdx++;
          nextInit();
        };
        els.initO.appendChild(btn);
      });

      startTime = Date.now();

      setTimeout(() => {
        els.initQ.classList.add('fade-out');
        setTimeout(() => {
          els.initQ.style.display = 'none';
          els.initO.style.display = 'flex';
        }, 500);
      }, 2500);
    }

    function startTraining() {
      els.t2.style.display = 'block';
      trainRound = 0;
      trainIdx = 0;
      showTraining();
    }

    function showTraining() {
      if (trainRound >= 8) {
        els.t2.style.display = 'none';
        startPost();
        return;
      }

      const idiom = idioms[trainIdx];
      els.t2Text.textContent = idiom.text;
      els.t2Def.textContent = idiom.meaningEn;
      const imgName = idiom.text.toLowerCase().replace(/[^a-z]+/g, '-') + '.jpg';
      els.idiomImg.src = `images/${imgName}`;

      els.t2Audio.onclick = () => {
        const u = new SpeechSynthesisUtterance(idiom.text);
        u.lang = 'en-US';
        speechSynthesis.speak(u);
      };
    }

    els.t2Next.addEventListener('click', () => {
      trainIdx++;
      if (trainIdx >= idioms.length) {
        trainIdx = 0;
        trainRound++;
      }
      showTraining();
    });

    function startPost() {
      els.postDiv.style.display = 'block';
      postIdx = 0;
      nextPost();
    }

    function nextPost() {
      if (postIdx >= idioms.length) {
        els.postDiv.style.display = 'none';
        showResult();
        return;
      }

      const cur = idioms[postIdx];
      els.postQ.textContent = `${postIdx + 1}. ${cur.text}`;
      els.postO.innerHTML = '';

      const wrong = getRandomWrong(postIdx);
      const opts = [cur.meaningEn, wrong.meaningEn].sort();
      opts.forEach(opt => {
        const btn = document.createElement('button');
        btn.className = 'option-btn';
        btn.textContent = opt;
        btn.onclick = () => {
          responsesPost.push({ correct: opt === cur.meaningEn, time: Date.now() - startTime });
          postIdx++;
          nextPost();
        };
        els.postO.appendChild(btn);
      });

      startTime = Date.now();
    }

    function showResult() {
      els.result.style.display = 'block';
      const score1 = responsesInit.filter(r => r.correct).length;
      const score2 = responsesPost.filter(r => r.correct).length;
      const avg1 = responsesInit.reduce((a, r) => a + r.time, 0) / responsesInit.length;
      const avg2 = responsesPost.reduce((a, r) => a + r.time, 0) / responsesPost.length;

      els.score.textContent = `Correct Answers: Before ${score1}/${idioms.length}, After ${score2}/${idioms.length}`;
      els.time.textContent = `Avg. Response Time: Before ${avg1.toFixed(2)} ms, After ${avg2.toFixed(2)} ms`;

      new Chart(els.chart.getContext('2d'), {
        type: 'bar',
        data: {
          labels: idioms.map((_, i) => `Q${i + 1}`),
          datasets: [
            { label: 'Before', data: responsesInit.map(r => r.time), backgroundColor: '#bb86fc' },
            { label: 'After', data: responsesPost.map(r => r.time), backgroundColor: '#03dac5' }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            title: { display: true, text: 'Response Times Before and After' }
          }
        }
      });
    }
    fetch('/submit-slow', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify(data)
});
  </script>
</body>
</html>
